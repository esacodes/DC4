---
title: "Data Challenge 4"
author: "Nage Ngo, Carol Milton, Esa Schenck"
date: "3/24/2021"
output:   
  html_document:
    toc: true
    toc_depth: 3
    theme: cosmo
    highlight: tango
    toc_float: true
    code_folding: hide
---

#Working with tidytext

```{r set up, include = F}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, error = F)
library(tidyverse)
library(tidytext)
library(tidygraph)
library(ggraph)
```

# Firewall 

```{r}
Firewall_04072012 <- readr::read_csv("DC4-data/Firewall/Firewall-04072012.csv")
```

Network 

```{r}
# id_sus <- id_sus %>%
#   full_join(ext_id)
# morning sunday: until 2014-06-08 13:16:27	

netw <- Firewall_04072012 %>% select(`Source IP`, `Destination IP`)
#node list
sources <- netw %>% distinct(`Source IP`) %>% rename( id = `Source IP`) %>% mutate(from = "from")
destinations <- netw %>% distinct(`Destination IP`) %>% rename(id = `Destination IP`)
nodes <- full_join(sources, destinations, by = "id") %>% distinct(id,.keep_all=T) %>% 
  mutate(f = ifelse(from=="from", "from", "to")) %>% select(id,f)

#edge list
per_route <- netw %>%  
  group_by(`Source IP`, `Destination IP`) %>%
  summarise(weight = n()) %>% 
  ungroup()
edges <- per_route %>% 
  left_join(nodes, by = c(`Source IP` = "id"))
edges <- edges %>% 
  left_join(nodes, by = c(`Destination IP` = "id"))
edges <- select(edges, from = `Source IP`, to = `Destination IP`, weight)
```

```{r}
# A tbl_graph consists of two tibbles: an edges tibble and a nodes tibble
routes_tidy <- tbl_graph(nodes = nodes, edges = edges, directed = TRUE) 

nw <- ggraph(routes_tidy, layout = "auto") 
  # geom_edge_link(aes(color = weight, width = weight), alpha = 0.7) + 
  # scale_edge_width(range = c(0.2, 2)) +
  # scale_edge_colour_gradient(low = "#f09c9c",
  #                            high = "#d60d0d",
  #                            space = "Lab") +
  # geom_node_point(aes(colour = ifelse(f=="from" ,"#0f0fa3","#635d5d")), show.legend = FALSE) + theme_graph()+
  # geom_node_text(aes(label = ifelse(f=="from", id, NA)), repel = TRUE) 

nw
```

#Working with tidytext

```{r}
library(tidyverse)
library(tidytext)
library(RMySQL)
```

```{r}
#i looked at https://datacarpentry.org/R-ecology-lesson/05-r-and-databases.html#introduction
#BUT this is from https://www.datacareer.de/blog/connect-to-postgresql-with-r-a-step-by-step-example/

#You need to have RPostgreSQL and RPostgres installed for this

#con<-dbConnect(RPostgres::Postgres())

library(DBI)
```
```{r}
db <- 'postgres'  #provide the name of your db

host_db <- 'database-dc4.cimcghmqvw06.us-east-2.rds.amazonaws.com'  

db_port <- 5432  # or any other port specified by the DBA

db_user <- 'dc4'

db_password <- 'password'

con <- dbConnect(RPostgres::Postgres(), dbname = db, 
                 host=host_db, port=db_port, user=db_user, password=db_password)
#db
#host_db
#db_port
#db_user
#db_password
```

```{r}
# from https://www.datacareer.de/blog/connect-to-postgresql-with-r-a-step-by-step-example/

dbListTables(con)
##IT WORKS!!!
```

```{r}
firewall_0407_short <- read_csv("Firewall-04072012.csv") %>% head(60)
```

```{r}
#from https://www.r-bloggers.com/2016/02/using-postgresql-in-r-a-quick-how-to/
dbWriteTable(con,'trial_0407',firewall_0406_short, row.names=FALSE)
```

```{r}
dbListTables(con)
dbReadTable(con, "trial_0407")
```



```{r}
#I'm taking the first 600,000 rows of the firewall data because these are MASSIVE files and R will crash. I'm thinking once we're sure what we're going to do and have done some exploratory stuff, then we can make R do it with the full rows and be prepared for it to take a while (or alternatively we can use tableau, or think about using a database)
firewall_0406_short <- read_csv("Firewall-04062012.csv") %>% head(600000)
firewall_0407_short <- read_csv("Firewall-04072012.csv") %>% head(600000)
ids_0406 <- read_csv("IDS-0406-updated.csv")
ids_0407 <- read_csv("IDS-0407.csv")
```

